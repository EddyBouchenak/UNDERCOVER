<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Undercover Pro - Tablet & Mobile</title>
    <style>
        :root {
            --bg-color: #0f0f1e;
            --card-bg: rgba(255, 255, 255, 0.08);
            --accent: #f1c40f;
            --green: #2ecc71;
            --red: #e74c3c;
            --blue: #3498db;
            --text: #ffffff;
            --safe-area-top: env(safe-area-inset-top);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; padding: 0;
            height: 100vh; display: flex; justify-content: center;
            overflow: hidden; touch-action: manipulation;
        }

        #app-container {
            width: 100%;
            max-width: 500px; /* Mobile par d√©faut */
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            padding-top: var(--safe-area-top);
            transition: max-width 0.3s;
        }

        /* --- ADAPTATION TABLETTE --- */
        @media (min-width: 768px) {
            #app-container { max-width: 90%; }
            h1 { font-size: 2.2rem !important; }
            button { font-size: 1.5rem !important; padding: 25px !important; }
            .player-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .important-zoom { font-size: 4rem !important; }
        }

        header {
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        h1 { grid-column: 2; font-size: 1.4rem; color: var(--accent); margin: 0; text-transform: uppercase; letter-spacing: 2px; text-align: center; }

        #btn-home-icon {
            grid-column: 1; background: rgba(255, 255, 255, 0.1); border: none;
            width: 45px; height: 45px; border-radius: 50%; font-size: 1.3rem;
            color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        .view { flex-grow: 1; padding: 20px; display: none; flex-direction: column; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .view.active { display: flex; }

        button { border: none; border-radius: 16px; padding: 18px; font-size: 1.1rem; font-weight: 800; width: 100%; margin-bottom: 10px; cursor: pointer; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-green { background: var(--green); color: #fff; }
        .btn-red { background: var(--red); color: #fff; }
        .btn-blue { background: var(--blue); color: #fff; }
        button:disabled { opacity: 0.3; filter: grayscale(1); }

        input[type="text"] {
            width: 100%; padding: 18px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05); color: white; font-size: 1.2rem; margin-bottom: 10px; outline: none; text-align: center;
        }

        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 15px; }

        .player-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 16px 20px; border-radius: 12px;
            margin-bottom: 8px; border-left: 5px solid var(--blue);
        }

        .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .spacer { flex-grow: 1; }
        .text-center { text-align: center; }

        .important-zoom { font-size: 2.8rem; font-weight: 900; color: var(--green); margin: 20px 0; display: block; text-align: center; text-shadow: 0 0 15px rgba(46, 204, 113, 0.3); }

        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 1000; display: none;
            flex-direction: column; justify-content: center; align-items: center; padding: 30px; backdrop-filter: blur(10px);
        }
        .modal-overlay.active { display: flex; }

        .setting-box { background: rgba(255,255,255,0.03); padding: 18px; border-radius: 18px; margin-bottom: 12px; }
        .counter-btn { background: var(--blue); color: white; width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: bold; }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <button id="btn-home-icon" onclick="confirmHome()">üè†</button>
        <h1>Undercover</h1>
    </header>

    <div id="view-setup" class="view active">
        <div class="card">
            <div class="row">
                <input type="text" id="new-player-input" placeholder="Pr√©nom du joueur..." autocomplete="off">
                <button class="btn-green" style="width: 70px; padding: 14px;" onclick="addPlayer()">+</button>
            </div>
        </div>
        <div id="players-list" class="player-grid"></div>
        <div class="spacer"></div>
        <div id="setup-controls">
            <div class="setting-box row">
                <span>üèÜ Objectif</span>
                <div class="row">
                    <div class="counter-btn" onclick="updateScoreLimit(-5)">-</div>
                    <span id="score-limit-display" style="min-width: 40px; text-align: center; font-weight: bold;">20</span>
                    <div class="counter-btn" onclick="updateScoreLimit(5)">+</div>
                </div>
            </div>
            <div class="setting-box">
                <div class="row" style="margin-bottom: 15px;">
                    <span>üïµÔ∏è Undercovers</span>
                    <div class="row">
                        <div class="counter-btn" onclick="updateCount('undercover', -1)">-</div>
                        <span id="count-undercover" style="min-width: 30px; text-align: center;">1</span>
                        <div class="counter-btn" onclick="updateCount('undercover', 1)">+</div>
                    </div>
                </div>
                <div class="row">
                    <span>ü§° Mr. White</span>
                    <div class="row">
                        <div class="counter-btn" onclick="updateCount('white', -1)">-</div>
                        <span id="count-white" style="min-width: 30px; text-align: center;">0</span>
                        <div class="counter-btn" onclick="updateCount('white', 1)">+</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn-primary" id="btn-start" onclick="startGame()" disabled>LANCER LA PARTIE</button>
    </div>

    <div id="view-distribution" class="view">
        <div class="spacer"></div>
        <div class="text-center">
            <div style="font-size: 1.2rem; opacity: 0.7;">Passez l'appareil √†</div>
            <div id="distrib-player-name" style="font-size: 3.5rem; color: var(--accent); font-weight: 900; margin: 10px 0;">Joueur</div>
            <p style="opacity: 0.6;">Regarde seul ton secret</p>
        </div>
        <div id="secret-area" style="display:none;" class="card text-center"></div>
        <div class="spacer"></div>
        <button id="btn-reveal" class="btn-red" onclick="revealSecret()">R√âV√âLER MON SECRET</button>
        <button id="btn-next-player" class="btn-blue" style="display:none;" onclick="nextDistribution()">JOUEUR SUIVANT</button>
    </div>

    <div id="view-game" class="view">
        <div class="card" style="border: 2px solid var(--green); background: rgba(46, 204, 113, 0.1);">
            <p id="starter-name-text" class="text-center" style="margin:0; font-weight: 900; font-size: 1.3rem;"></p>
        </div>
        <div id="game-players-list" class="player-grid" style="margin-top: 15px;"></div>
    </div>

    <div id="view-gameover" class="view">
        <div id="grand-winner-area" style="display:none; background: linear-gradient(135deg, #f1c40f, #e67e22); color: black; padding: 25px; border-radius: 20px; font-weight: 800; margin-bottom: 20px; text-align: center;">
            üèÜ VICTOIRE FINALE<br>
            <span id="grand-winner-name" style="font-size: 2.2rem;"></span>
        </div>
        <div class="card text-center">
            <h2 id="winner-message" style="margin: 0 0 20px 0; color: var(--accent); font-size: 1.8rem;"></h2>
            <div style="text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <div style="margin-bottom: 15px;">
                    <span style="opacity: 0.7;">Mot Civil :</span><br>
                    <b style="color: var(--green); font-size: 2.2rem;" id="civil-word-reveal"></b>
                </div>
                <div id="under-reveal-box">
                    <span style="opacity: 0.7;">Mot Undercover :</span><br>
                    <b style="color: var(--red); font-size: 2.2rem;" id="under-word-reveal"></b>
                </div>
            </div>
        </div>
        <div id="scores-list" class="player-grid"></div>
        <div class="spacer"></div>
        <button id="btn-next-round" class="btn-primary" onclick="resetGame(false)">MANCHE SUIVANTE</button>
        <button id="btn-reset-all" class="btn-red" style="display:none;" onclick="resetGame(true)">NOUVELLE PARTIE</button>
    </div>

    <div id="home-confirm-modal" class="modal-overlay">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center;">
            <h3>Quitter la partie ?</h3>
            <button class="btn-red" onclick="goHome()">OUI, QUITTER</button>
            <button class="btn-blue" onclick="closeHomeModal()">ANNULER</button>
        </div>
    </div>

    <div id="mr-white-modal" class="modal-overlay">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center;">
            <h2 style="color: var(--red);">D√âMASQU√â !</h2>
            <p><b id="white-name" style="color:var(--accent)"></b>, devine le mot des civils :</p>
            <input type="text" id="white-guess-input" placeholder="Ton mot..." autocomplete="off">
            <button class="btn-green" onclick="validateWhiteGuess()">VALIDER</button>
        </div>
    </div>
</div>

<script>
    // Liste simplifi√©e pour l'exemple
    const database = [
        ["Guitare", "Violon"], ["Bi√®re", "Cidre"], ["Lion", "Tigre"], ["Pomme", "Poire"], ["Plage", "Piscine"], ["Facebook", "Twitter"], ["McDonald's", "Burger King"], ["Paris", "Londres"], ["Soleil", "Lune"], ["Chien", "Chat"], ["Voiture", "Moto"], ["Th√©", "Caf√©"], ["Foot", "Rugby"], ["Piano", "Clavier"], ["Stylo", "Crayon"], ["Avion", "H√©licopt√®re"], ["Coca", "Pepsi"], ["Netflix", "YouTube"], ["Chocolat", "Vanille"], ["Pizza", "P√¢tes"], ["Vampire", "Loup-garou"], ["Ninja", "Samoura√Ø"], ["Sushi", "Maki"], ["Riz", "P√¢te"]
    ];

    let players = [];
    let config = { undercovers: 1, whites: 0, winningScore: 20 };
    let currentCivilWord = "", currentUnderWord = "", distributionIndex = 0;
    let playerBeingEliminated = null;
    let gameInProgress = false;

    function addPlayer() {
        const input = document.getElementById('new-player-input');
        const name = input.value.trim();
        if (name) {
            players.push({ id: Date.now() + Math.random(), name, role: null, word: null, eliminated: false, score: 0, lastPoints: 0 });
            input.value = "";
            renderPlayersList();
            autoAdjustRoles();
        }
    }

    function renderPlayersList() {
        const list = document.getElementById('players-list');
        list.innerHTML = players.map(p => `
            <div class="player-item">
                <b>${p.name}</b>
                <span>${p.score} pts</span>
            </div>
        `).join('');
        document.getElementById('btn-start').disabled = players.length < 3;
    }

    function updateCount(type, delta) {
        if (type === 'undercover') config.undercovers = Math.max(0, Math.min(5, config.undercovers + delta));
        else config.whites = Math.max(0, Math.min(5, config.whites + delta));
        document.getElementById('count-undercover').innerText = config.undercovers;
        document.getElementById('count-white').innerText = config.whites;
    }

    function updateScoreLimit(delta) {
        config.winningScore = Math.max(5, config.winningScore + delta);
        document.getElementById('score-limit-display').innerText = config.winningScore;
    }

    function autoAdjustRoles() {
        const total = players.length;
        config.undercovers = total <= 5 ? 1 : total <= 8 ? 2 : 3;
        document.getElementById('count-undercover').innerText = config.undercovers;
    }

    function startGame() {
        gameInProgress = true;
        players.forEach(p => { p.eliminated = false; p.lastPoints = 0; });
        
        // Choisir mots
        const pair = database[Math.floor(Math.random() * database.length)];
        currentCivilWord = pair[0];
        currentUnderWord = pair[1];

        // Distribuer r√¥les al√©atoirement
        let roles = [];
        for(let i=0; i<config.undercovers; i++) roles.push('Undercover');
        for(let i=0; i<config.whites; i++) roles.push('Mr. White');
        while(roles.length < players.length) roles.push('Civil');
        
        // M√©lange (Fisher-Yates)
        for (let i = roles.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [roles[i], roles[j]] = [roles[j], roles[i]];
        }

        players.forEach((p, i) => {
            p.role = roles[i];
            p.word = (p.role === 'Civil') ? currentCivilWord : (p.role === 'Undercover' ? currentUnderWord : "???");
        });

        distributionIndex = 0;
        switchView('view-distribution');
        updateDistributionView();
    }

    function updateDistributionView() {
        const p = players[distributionIndex];
        document.getElementById('distrib-player-name').innerText = p.name;
        document.getElementById('secret-area').style.display = 'none';
        document.getElementById('btn-reveal').style.display = 'block';
        document.getElementById('btn-next-player').style.display = 'none';
    }

    function revealSecret() {
        const p = players[distributionIndex];
        const area = document.getElementById('secret-area');
        area.style.display = 'block';
        
        if (p.role === 'Mr. White') {
            area.innerHTML = `<div style="opacity:0.8">Tu es :</div><div class="important-zoom" style="color:var(--red)">MR. WHITE</div><p>Tu n'as pas de mot. Devine celui des autres !</p>`;
        } else {
            area.innerHTML = `<div style="opacity:0.8">Ton mot secret :</div><div class="important-zoom">${p.word}</div>`;
        }
        
        document.getElementById('btn-reveal').style.display = 'none';
        document.getElementById('btn-next-player').style.display = 'block';
    }

    function nextDistribution() {
        if (++distributionIndex < players.length) {
            updateDistributionView();
        } else { 
            startDiscussion();
        }
    }

    function startDiscussion() {
        // Choisir qui commence : JAMAIS Mr. White, forc√©ment un Civil
        const civils = players.filter(p => p.role === 'Civil');
        const starter = civils[Math.floor(Math.random() * civils.length)];
        
        document.getElementById('starter-name-text').innerText = `üåü ${starter.name} COMMENCE !`;
        renderGamePlayers();
        switchView('view-game');
    }

    function renderGamePlayers() {
        document.getElementById('game-players-list').innerHTML = players.map(p => `
            <div class="player-item" style="${p.eliminated ? 'opacity:0.4; border-color:var(--red)' : ''}">
                <div>
                    <b style="font-size:1.2rem">${p.name}</b>
                    ${p.eliminated ? `<br><small style="color:var(--red)">${p.role.toUpperCase()}</small>` : ''}
                </div>
                ${!p.eliminated ? `<button class="btn-red" style="width:auto; padding:10px 20px; margin:0; font-size:0.9rem;" onclick="attemptEliminate('${p.id}')">√âLIMINER</button>` : '<span>‚ùå</span>'}
            </div>`).join('');
    }

    function attemptEliminate(id) {
        const p = players.find(x => x.id == id);
        playerBeingEliminated = p;
        if (p.role === 'Mr. White') {
            document.getElementById('white-name').innerText = p.name;
            document.getElementById('white-guess-input').value = "";
            document.getElementById('mr-white-modal').classList.add('active');
        } else {
            confirmElimination(p);
        }
    }

    function validateWhiteGuess() {
        const guess = document.getElementById('white-guess-input').value.trim().toLowerCase();
        document.getElementById('mr-white-modal').classList.remove('active');
        
        // On normalize le mot civil pour la comparaison
        if (guess === currentCivilWord.toLowerCase()) {
            playerBeingEliminated.score += 6;
            playerBeingEliminated.lastPoints = 6;
            endGame(`üé© MR. WHITE (${playerBeingEliminated.name}) A GAGN√â !`);
        } else {
            confirmElimination(playerBeingEliminated);
        }
    }

    function confirmElimination(p) {
        p.eliminated = true;
        renderGamePlayers();
        checkWinCondition();
    }

    function checkWinCondition() {
        const active = players.filter(p => !p.eliminated);
        const impostors = active.filter(p => p.role !== 'Civil').length;
        const civils = active.filter(p => p.role === 'Civil').length;

        if (impostors === 0) {
            players.filter(p => !p.eliminated).forEach(p => { p.score += 2; p.lastPoints = 2; });
            endGame("üéâ VICTOIRE DES CIVILS !");
        } else if (civils <= 1 && impostors >= 1) {
            players.filter(p => !p.eliminated && p.role !== 'Civil').forEach(p => { p.score += 4; p.lastPoints = 4; });
            endGame("üïµÔ∏è VICTOIRE DES IMPOSTEURS !");
        }
    }

    function endGame(msg) {
        document.getElementById('winner-message').innerText = msg;
        document.getElementById('civil-word-reveal').innerText = currentCivilWord;
        document.getElementById('under-word-reveal').innerText = currentUnderWord;
        
        const sorted = [...players].sort((a,b) => b.score - a.score);
        const winner = sorted.find(p => p.score >= config.winningScore);
        
        if (winner) {
            document.getElementById('grand-winner-area').style.display = 'block';
            document.getElementById('grand-winner-name').innerText = winner.name.toUpperCase();
            document.getElementById('btn-next-round').style.display = 'none';
            document.getElementById('btn-reset-all').style.display = 'block';
        } else {
            document.getElementById('grand-winner-area').style.display = 'none';
            document.getElementById('btn-next-round').style.display = 'block';
            document.getElementById('btn-reset-all').style.display = 'none';
        }

        document.getElementById('scores-list').innerHTML = sorted.map(p => `
            <div class="player-item">
                <div><b>${p.name}</b><br><small style="opacity:0.6">${p.role}</small></div>
                <div style="text-align:right"><b>${p.score} pts</b>${p.lastPoints ? `<br><small style="color:var(--green)">+${p.lastPoints}</small>` : ''}</div>
            </div>`).join('');
        switchView('view-gameover');
    }

    function resetGame(full) {
        if (full) { players.forEach(p => p.score = 0); }
        switchView('view-setup');
        renderPlayersList();
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function confirmHome() { document.getElementById('home-confirm-modal').classList.add('active'); }
    function closeHomeModal() { document.getElementById('home-confirm-modal').classList.remove('active'); }
    function goHome() { closeHomeModal(); resetGame(true); }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Undercover Mobile</title>
    <style>
        :root {
            --bg-color: #0f0f1e;
            --card-bg: rgba(255, 255, 255, 0.08);
            --accent: #f1c40f;
            --green: #2ecc71;
            --red: #e74c3c;
            --blue: #3498db;
            --text: #ffffff;
            --safe-area-top: env(safe-area-inset-top);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Supprime le rectangle gris au clic sur iOS */
            user-select: none; /* Emp√™che de copier le texte par erreur en jouant */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
            touch-action: manipulation;
        }

        #app-container {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            /* Gestion des encoches (iPhone notch) */
            padding-top: var(--safe-area-top);
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }

        h1 { font-size: 1.4rem; color: var(--accent); margin: 0; text-transform: uppercase; letter-spacing: 1px; }

        #btn-home-icon {
            position: absolute; left: 15px; background: none; border: none; font-size: 1.4rem; color: white; padding: 5px;
        }

        .view {
            flex-grow: 1;
            padding: 20px;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Scroll fluide sur iOS */
        }
        .view.active { display: flex; }

        /* Boutons optimis√©s pour le pouce */
        button {
            border: none;
            border-radius: 16px;
            padding: 18px; /* Plus grand pour le tactile */
            font-size: 1.1rem;
            font-weight: 700;
            width: 100%;
            margin-bottom: 10px;
            transition: transform 0.05s, opacity 0.2s;
        }
        button:active { transform: scale(0.96); opacity: 0.8; }
        
        .btn-primary { background: var(--accent); color: #000; }
        .btn-green { background: var(--green); color: #fff; }
        .btn-red { background: var(--red); color: #fff; }
        .btn-blue { background: var(--blue); color: #fff; }
        
        /* Inputs styl√©s */
        input[type="text"] {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 1rem;
            margin-bottom: 10px;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--blue); }

        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; }

        /* Liste des joueurs plus a√©r√©e */
        .player-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 14px 18px; border-radius: 12px; margin-bottom: 8px;
            border-left: 4px solid var(--blue);
        }

        .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .spacer { flex-grow: 1; }

        /* Animation de fin */
        .grand-winner-banner {
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            color: black; padding: 25px; border-radius: 20px; font-weight: 800;
            margin-bottom: 20px; text-align: center;
        }

        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 1000;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; padding: 30px; text-align: center;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; }

        /* Settings compacts */
        .setting-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; margin-bottom: 10px; }
        .counter-btn {
            background: var(--blue); color: white; width: 40px; height: 40px;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <button id="btn-home-icon" onclick="confirmHome()">üè†</button>
        <h1>Undercover</h1>
    </header>

    <div id="view-setup" class="view active">
        <div class="card">
            <div class="row">
                <input type="text" id="new-player-input" placeholder="Pr√©nom du joueur..." autocomplete="off">
                <button class="btn-green" style="width: 60px; padding: 14px;" onclick="addPlayer()">+</button>
            </div>
        </div>

        <div id="players-list"></div>

        <div class="spacer"></div>

        <div id="setup-controls">
            <div id="score-setting-container" class="setting-box row">
                <span>üèÜ Objectif :</span>
                <div class="row">
                    <div class="counter-btn" onclick="updateScoreLimit(-5)">-</div>
                    <span id="score-limit-display" style="min-width: 30px; text-align: center; font-weight: bold;">20</span>
                    <div class="counter-btn" onclick="updateScoreLimit(5)">+</div>
                </div>
            </div>

            <div id="role-setting-container" class="setting-box">
                <div class="row" style="margin-bottom: 10px;">
                    <span>üïµÔ∏è Undercovers</span>
                    <div class="row">
                        <div class="counter-btn" onclick="updateCount('undercover', -1)">-</div>
                        <span id="count-undercover" style="min-width: 20px; text-align: center;">1</span>
                        <div class="counter-btn" onclick="updateCount('undercover', 1)">+</div>
                    </div>
                </div>
                <div class="row">
                    <span>ü§° Mr. White</span>
                    <div class="row">
                        <div class="counter-btn" onclick="updateCount('white', -1)">-</div>
                        <span id="count-white" style="min-width: 20px; text-align: center;">0</span>
                        <div class="counter-btn" onclick="updateCount('white', 1)">+</div>
                    </div>
                </div>
            </div>
        </div>

        <button class="btn-primary" id="btn-start" onclick="startGame()" disabled>LANCER LA MANCHE</button>
    </div>

    <div id="view-distribution" class="view">
        <div class="spacer"></div>
        <div id="first-player-msg" style="color: var(--green); text-align: center; font-weight: bold; margin-bottom: 10px;">‚≠ê TU COMMENCES !</div>
        <div class="text-center">
            <h2 style="opacity: 0.7;">Au tour de</h2>
            <div id="distrib-player-name" class="big-name">Joueur</div>
            <p>Appuie pour d√©couvrir ton secret</p>
        </div>
        
        <div id="secret-area" style="display:none;" class="card text-center"></div>
        <div class="spacer"></div>
        
        <button id="btn-reveal" class="btn-red" onclick="revealSecret()">R√âV√âLER MON MOT</button>
        <button id="btn-next-player" class="btn-blue" style="display:none;" onclick="nextDistribution()">JOUEUR SUIVANT</button>
    </div>

    <div id="view-game" class="view">
        <div class="card" style="border: 1px solid var(--green);">
            <p id="starter-name-text" class="text-center" style="margin:0; font-weight: bold;"></p>
        </div>
        <div id="game-players-list" style="margin-top: 10px;"></div>
    </div>

    <div id="view-gameover" class="view">
        <div id="grand-winner-area" class="grand-winner-banner" style="display:none;">
            üèÜ VICTOIRE FINALE<br>
            <span id="grand-winner-name" style="font-size: 1.8rem;"></span>
        </div>

        <div class="card text-center">
            <h2 id="winner-message" style="margin: 0 0 15px 0; color: var(--accent);"></h2>
            <div style="text-align: left; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <p>Mot Civil : <b style="color: var(--green);" id="civil-word-reveal"></b></p>
                <p>Mot Undercover : <b style="color: var(--red);" id="under-word-reveal"></b></p>
            </div>
        </div>
        
        <div id="scores-list"></div>
        <div class="spacer"></div>
        <button id="btn-next-round" class="btn-primary" onclick="resetGame(false)">MANCHE SUIVANTE</button>
        <button id="btn-reset-all" class="btn-red" style="display:none;" onclick="resetGame(true)">NOUVELLE PARTIE</button>
    </div>

    <div id="home-confirm-modal" class="modal-overlay">
        <div class="card" style="width: 100%;">
            <h3>Quitter la partie ?</h3>
            <p style="opacity: 0.6;">Toute la progression sera perdue.</p>
            <button class="btn-red" onclick="goHome()">QUITTER</button>
            <button class="btn-blue" onclick="closeHomeModal()">ANNULER</button>
        </div>
    </div>

    <div id="mr-white-modal" class="modal-overlay">
        <div class="card" style="width: 100%;">
            <h2 style="color: var(--red);">D√âMASQU√â !</h2>
            <p><b id="white-name"></b>, devine le mot des civils :</p>
            <input type="text" id="white-guess-input" placeholder="Ton guess..." autocomplete="off">
            <button class="btn-green" onclick="validateWhiteGuess()">VALIDER</button>
        </div>
    </div>
</div>

<script>
    /* LOGIQUE JS (CONSERV√âE ET ADAPT√âE) */
    const database = [["Guitare", "Violon"], ["Bi√®re", "Cidre"], ["Lion", "Tigre"], ["Pomme", "Poire"], ["Plage", "Piscine"], ["Facebook", "Twitter"], ["Harry Potter", "Seigneur des Anneaux"], ["McDonald's", "Burger King"], ["Paris", "Londres"], ["Soleil", "Lune"], ["Chien", "Chat"], ["Voiture", "Moto"], ["Th√©", "Caf√©"], ["Foot", "Rugby"], ["Piano", "Clavier"], ["Stylo", "Crayon"], ["Montre", "Horloge"], ["Bateau", "Paquebot"], ["Avion", "H√©licopt√®re"], ["Pantalon", "Short"], ["Chemise", "T-shirt"], ["Lunettes", "Lentilles"], ["Chaise", "Tabouret"], ["Lit", "Canap√©"], ["Douche", "Bain"], ["Banane", "Kiwi"], ["Orange", "Cl√©mentine"], ["Or", "Argent"], ["Diamant", "Rubis"], ["Coca", "Pepsi"], ["Netflix", "YouTube"], ["Uber", "Taxi"], ["Chocolat", "Vanille"], ["Pain", "Brioche"], ["Pizza", "P√¢tes"], ["Fromage", "Yaourt"], ["Vin", "Champagne"], ["No√´l", "Nouvel An"], ["Mariage", "PACS"], ["√âcole", "Universit√©"], ["Professeur", "√âl√®ve"], ["Docteur", "Infirmier"], ["Police", "Pompier"], ["Roi", "Pr√©sident"], ["Ch√¢teau", "Manoir"], ["For√™t", "Jungle"], ["Montagne", "Colline"], ["Neige", "Glace"], ["Pluie", "Orage"], ["Vent", "Temp√™te"], ["Rivi√®re", "Fleuve"], ["D√©sert", "Plage"], ["Volcan", "Montagne"], ["Cin√©ma", "Th√©√¢tre"], ["Bar", "Bo√Æte de nuit"], ["Biblioth√®que", "Librairie"], ["Mus√©e", "Galerie"], ["H√¥tel", "Camping"], ["Prison", "Cachot"], ["Abeille", "Gu√™pe"], ["Crocodile", "Alligator"], ["Chouette", "Hibou"], ["Cheval", "Poney"], ["Lapin", "Li√®vre"], ["Dauphin", "Requin"], ["Aigle", "Faucon"], ["Moustique", "Mouche"], ["Loup", "Renard"], ["Superman", "Batman"], ["P√®re No√´l", "Lutin"], ["Vampire", "Loup-garou"], ["Ange", "D√©mon"], ["Sorcier", "Magicien"], ["Pirate", "Marin"], ["Ninja", "Samoura√Ø"], ["Savon", "Shampoing"], ["Brosse √† dents", "Dentifrice"], ["Four", "Micro-ondes"], ["Frigo", "Cong√©lateur"], ["Lampe", "Bougie"], ["Miroir", "Vitre"], ["Cl√©", "Serrure"], ["Ketchup", "Mayonnaise"], ["Sel", "Poivre"], ["Sucre", "Miel"], ["Cr√™pe", "Gaufre"], ["Pain au chocolat", "Chocolatine"], ["Sushi", "Maki"], ["Riz", "P√¢te"], ["Salade", "√âpinard"], ["Eau plate", "Eau gazeuse"], ["Thon", "Saumon"], ["Poulet", "Dinde"]];
    let players = [], config = { undercovers: 1, whites: 0, winningScore: 20 }, currentCivilWord = "", currentUnderWord = "", distributionIndex = 0, playerBeingEliminated = null, gameInProgress = false;

    function addPlayer() {
        const input = document.getElementById('new-player-input');
        const name = input.value.trim();
        if (name) {
            players.push({ id: Date.now()+Math.random(), name, role: null, word: null, eliminated: false, score: 0, lastPoints: 0 });
            input.value = ""; renderPlayersList(); autoAdjustRoles();
        }
    }

    function renderPlayersList() {
        const list = document.getElementById('players-list');
        list.innerHTML = players.map(p => `<div class="player-item"><b>${p.name}</b><span>${p.score} pts</span></div>`).join('');
        document.getElementById('btn-start').disabled = players.length < 3;
    }

    function updateCount(type, delta) {
        if (type === 'undercover') config.undercovers = Math.max(0, Math.min(5, config.undercovers + delta));
        else config.whites = Math.max(0, Math.min(5, config.whites + delta));
        document.getElementById('count-undercover').innerText = config.undercovers;
        document.getElementById('count-white').innerText = config.whites;
    }

    function updateScoreLimit(delta) {
        config.winningScore = Math.max(5, config.winningScore + delta);
        document.getElementById('score-limit-display').innerText = config.winningScore;
    }

    function autoAdjustRoles() {
        const total = players.length;
        config.undercovers = total <= 5 ? 1 : total <= 8 ? 2 : 3;
        document.getElementById('count-undercover').innerText = config.undercovers;
    }

    function startGame() {
        gameInProgress = true;
        players.forEach(p => { p.eliminated = false; p.lastPoints = 0; });
        const offset = Math.floor(Math.random() * players.length);
        players = players.slice(offset).concat(players.slice(0, offset));
        
        const pair = database[Math.floor(Math.random() * database.length)];
        currentCivilWord = pair[0]; currentUnderWord = pair[1];

        let roles = [];
        for(let i=0; i<config.undercovers; i++) roles.push('Undercover');
        for(let i=0; i<config.whites; i++) roles.push('Mr. White');
        while(roles.length < players.length) roles.push('Civil');
        roles.sort(() => Math.random() - 0.5);

        players.forEach((p, i) => {
            p.role = roles[i];
            p.word = (p.role === 'Civil') ? currentCivilWord : (p.role === 'Undercover' ? currentUnderWord : null);
        });

        if (players[0].role === 'Mr. White') {
            const swapIdx = players.findIndex(p => p.role !== 'Mr. White');
            [players[0].role, players[swapIdx].role] = [players[swapIdx].role, players[0].role];
            [players[0].word, players[swapIdx].word] = [players[swapIdx].word, players[0].word];
        }

        distributionIndex = 0; switchView('view-distribution'); updateDistributionView();
    }

    function updateDistributionView() {
        const p = players[distributionIndex];
        document.getElementById('distrib-player-name').innerText = p.name;
        document.getElementById('first-player-msg').style.display = (distributionIndex === 0) ? 'block' : 'none';
        document.getElementById('secret-area').style.display = 'none';
        document.getElementById('btn-reveal').style.display = 'block';
        document.getElementById('btn-next-player').style.display = 'none';
    }

    function revealSecret() {
        const p = players[distributionIndex];
        const area = document.getElementById('secret-area');
        area.style.display = 'block';
        area.innerHTML = p.role === 'Mr. White' ? `<div class="mr-white-text">Tu es Mr. WHITE !</div>` : `<div>Ton mot secret :</div><div class="secret-word">${p.word}</div>`;
        document.getElementById('btn-reveal').style.display = 'none';
        document.getElementById('btn-next-player').style.display = 'block';
    }

    function nextDistribution() {
        if (++distributionIndex < players.length) updateDistributionView();
        else { switchView('view-game'); setupGameView(); }
    }

    function setupGameView() {
        document.getElementById('starter-name-text').innerText = `‚≠ê ${players[0].name} commence !`;
        renderGamePlayers();
    }

    function renderGamePlayers() {
        document.getElementById('game-players-list').innerHTML = players.map(p => `
            <div class="player-item" style="${p.eliminated ? 'opacity:0.5; border-color:var(--red)' : ''}">
                <div><b>${p.name}</b> ${p.eliminated ? `<br><small style="color:var(--red)">${p.role}</small>` : ''}</div>
                ${!p.eliminated ? `<button class="btn-red" style="width:auto; padding:10px 15px; margin:0;" onclick="attemptEliminate('${p.id}')">Voter</button>` : '<span>‚ùå</span>'}
            </div>`).join('');
    }

    function attemptEliminate(id) {
        const p = players.find(x => x.id == id);
        playerBeingEliminated = p;
        if (p.role === 'Mr. White') {
            document.getElementById('white-name').innerText = p.name;
            document.getElementById('white-guess-input').value = "";
            document.getElementById('mr-white-modal').classList.add('active');
        } else confirmElimination(p);
    }

    function validateWhiteGuess() {
        const guess = document.getElementById('white-guess-input').value.trim().toLowerCase();
        document.getElementById('mr-white-modal').classList.remove('active');
        if (guess === currentCivilWord.toLowerCase()) {
            playerBeingEliminated.score += 6; playerBeingEliminated.lastPoints = 6;
            endGame(`üé© Mr. White (${playerBeingEliminated.name}) a gagn√© !`);
        } else confirmElimination(playerBeingEliminated);
    }

    function confirmElimination(p) {
        p.eliminated = true; renderGamePlayers(); checkWinCondition();
    }

    function checkWinCondition() {
        const active = players.filter(p => !p.eliminated);
        const impostors = active.filter(p => p.role !== 'Civil').length;
        const civils = active.filter(p => p.role === 'Civil').length;
        if (impostors === 0) {
            players.filter(p => !p.eliminated).forEach(p => { p.score += 2; p.lastPoints = 2; });
            endGame("üéâ Victoire des Civils !");
        } else if (civils === 0) {
            players.filter(p => !p.eliminated && p.role === 'Undercover').forEach(p => { p.score += 10; p.lastPoints = 10; });
            endGame("üïµÔ∏è Victoire des Imposteurs !");
        }
    }

    function endGame(msg) {
        document.getElementById('winner-message').innerText = msg;
        document.getElementById('civil-word-reveal').innerText = currentCivilWord;
        document.getElementById('under-word-reveal').innerText = currentUnderWord;
        const sorted = [...players].sort((a,b) => b.score - a.score);
        const winner = sorted.find(p => p.score >= config.winningScore);
        
        if (winner) {
            gameInProgress = false;
            document.getElementById('grand-winner-area').style.display = 'block';
            document.getElementById('grand-winner-name').innerText = winner.name;
            document.getElementById('btn-next-round').style.display = 'none';
            document.getElementById('btn-reset-all').style.display = 'block';
        } else {
            document.getElementById('grand-winner-area').style.display = 'none';
            document.getElementById('btn-next-round').style.display = 'block';
            document.getElementById('btn-reset-all').style.display = 'none';
        }

        document.getElementById('scores-list').innerHTML = sorted.map(p => `
            <div class="player-item">
                <div><b>${p.name}</b><br><small>${p.role}</small></div>
                <div style="text-align:right"><b>${p.score} / ${config.winningScore}</b>${p.lastPoints ? `<br><small style="color:var(--green)">+${p.lastPoints}</small>` : ''}</div>
            </div>`).join('');
        switchView('view-gameover');
    }

    function resetGame(full) {
        if (full) { players.forEach(p => p.score = 0); gameInProgress = false; }
        document.getElementById('score-setting-container').style.display = gameInProgress ? 'none' : 'flex';
        document.getElementById('role-setting-container').style.display = gameInProgress ? 'none' : 'block';
        if (!full && gameInProgress) startGame(); else { switchView('view-setup'); renderPlayersList(); }
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function confirmHome() { document.getElementById('home-confirm-modal').classList.add('active'); }
    function closeHomeModal() { document.getElementById('home-confirm-modal').classList.remove('active'); }
    function goHome() { closeHomeModal(); resetGame(true); }
</script>
</body>
</html>